<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>websockt</title>
    <script>
        console.log("休息休息");
        var lockReconnect = false;//避免重复连接
        var ws;
        var tt;
        //创建链接
        createWebSocket();

        //创建链接
        function createWebSocket() {
            try {
                ws = new WebSocket("ws://localhost:8778/websocket/5");
                // 初始化链接
                init();
            } catch (e) {
                console.log('catch' + e);
                reconnect(wsUrl);
            }
        }

        /**
         * 初始化链接
         */
        function init() {
            ws.onopen = function (evt) {
                console.log("Connection open ...");
                ws.send("Hello WebSockets!");

                //心跳检测重置
                heartCheck.start();
            };


            ws.onmessage = function (evt) {
                console.log("Received Message: " + evt.data);
                // ws.close();
            };

            ws.onclose = function (evt) {
                console.log("Connection closed.");
            };

            ws.addEventListener("open", function (event) {
                var binary = new Array();
                for (var i = 0; i < 5; i++) {
                    binary[i] = new Date();
                }
                ws.send(binary);
            });
            ws.addEventListener("error", function (event) {
                // handle error event
                var code = event.code;
                var reason = event.reason;
                var wasClean = event.wasClean;
                console.log(code + "  " + reason + "  " + wasClean);
                console.log(" error! " + event.message);
            });
        }


        //重试连接socket
        function reconnect(wsUrl) {
            if (lockReconnect) {
                return;
            }
            ;
            lockReconnect = true;
            //没连接上会一直重连，设置延迟避免请求过多
            tt && clearTimeout(tt);
            tt = setTimeout(function () {
                createWebSocket(wsUrl);
                lockReconnect = false;
            }, 180000);
        }

        //心跳检测
        var heartCheck = {
            timeout: 210000,
            timeoutObj: null,
            serverTimeoutObj: null,
            start: function () {
                console.log(new Date() + " Socket 心跳检测");
                var self = this;
                this.timeoutObj && clearTimeout(this.timeoutObj);
                this.serverTimeoutObj && clearTimeout(this.serverTimeoutObj);
                this.timeoutObj = setTimeout(function () {
                    //这里发送一个心跳，后端收到后，返回一个心跳消息，
                    //onmessage拿到返回的心跳就说明连接正常
                    console.log(new Date() + ' Socket 连接重试');
                    ws.send("连接成功");
                    self.serverTimeoutObj = setTimeout(function () {
                        console.log(ws);
                        ws.close();
                    }, self.timeout);
                }, this.timeout)
            }
        }
    </script>
</head>
<body>
<h1>演示websocket!!!</h1>
<button onclick="this.innerHTML=Date()">现在的时间是?</button>
</body>
</html>